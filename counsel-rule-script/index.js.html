<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>index.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading">Classes</li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="ScriptRule.html">ScriptRule</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="ScriptRule.html#apply">apply</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="ScriptRule.html#check">check</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="ScriptRule.ScriptRule.html">ScriptRule</a></span></li>
</nav>

<div id="main">
    
    <h1 class="page-title">index.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict'

const Rule = require('counsel-rule')

/**
 * Adds a script to the target package's package.json
 *
 * @class ScriptRule
 * @extends {Rule}
 */
class ScriptRule extends Rule {
  /**
   * Creates an instance of ScriptRule.
   *
   * @param {object} opts
   * @param {string} opts.scriptName npm script name
   * @param {string} opts.scriptCommand npm script command
   * @param {string[]|RegExp[]} [opts.scriptCommandVariants] permitted variants of the script. '*' for permitting any alternative
   * @param {boolean} [opts.scriptAppend] default false. will append _exact_ script to any pre-existing
   * @param {function[]} [opts.overrideConditions] if any conditions true, will override
   * @memberOf ScriptRule
   */
  constructor (opts) {
    super(opts)
    if (!this.declaration.scriptName) throw new ReferenceError('script rule must contain a scriptName')
    if (!this.declaration.scriptCommand) throw new ReferenceError('script rule must contain a scriptcmd')
    const variants = opts.scriptCommandVariants
    this.isAnyVariantValid = variants &amp;&amp; variants.length
      ? (variants.indexOf('*') > -1 || variants === '*')
      : false
    if (opts.scriptAppend &amp;&amp; this.isAnyVariantValid) {
      throw new Error('cannot request scriptAppend and scriptCommandVariants w/ "*" simultaneously')
    }
  }
  /**
   * Adds the requested script to the package.json
   * @note Rule's shall not write the package.json file.  counsel shall
   * write the file on our behalf to not trash the disk and many rules may update
   * it
   * @memberOf ScriptRule
   * @override
   * @param {Module} counsel
   * @returns {undefined}
   */
  apply (counsel) {
    Rule.prototype.apply.apply(this, arguments)
    const pkg = counsel.targetProjectPackageJson
    const name = this.declaration.scriptName
    const cmd = this.declaration.scriptCommand
    const overrideConditions = this.declaration.overrideConditions || []
    const prexistingCmd = pkg.scripts ? pkg.scripts[name] : null
    const append = this.declaration.scriptAppend
    pkg.scripts = pkg.scripts || {}
    if (!prexistingCmd) {
      pkg.scripts[name] = cmd
      return
    }
    // script key already has cmd specified. handle it.
    if (append &amp;&amp; !prexistingCmd.match(cmd)) {
      pkg.scripts[name] = `${prexistingCmd} &amp;&amp; ${cmd}`
      return
    }

    if (overrideConditions.some(overrideCondition => overrideCondition(prexistingCmd))) {
      pkg.scripts[name] = cmd
      return
    }

    if (this.satisfiesVariants(counsel)) return
    const err = new Error(`failed to apply command "${cmd}" to script "${name}"`)
    err.code = 'ENOSCRIPTINSTALL'
    return Promise.reject(err)
  }

  /**
   * Asserts that the specified cmd exists in the corresponding script or that
   * an approved variant is present
   * @param {Counsel} counsel
   * @returns {Promise}
   */
  check (counsel) {
    const pkg = counsel.targetProjectPackageJson
    const name = this.declaration.scriptName
    const missingScriptError = new Error(`missing ${name} script in package.json`)
    missingScriptError.code = 'ENOSCRIPT'
    if (!pkg.scripts) return Promise.reject(missingScriptError)
    const actual = pkg.scripts[name]
    if (!actual) return Promise.reject(missingScriptError)
    const requested = this.declaration.scriptCommand
    if (
      requested.trim() === actual.trim() ||
      this.satisfiesVariants(counsel)
    ) return Promise.resolve()
    const err = new Error(`script ${name} not found with requested command or variants`)
    err.code = 'ENOSCRIPT'
    return Promise.reject(err)
  }

  getVariants () {
    return (this.declaration.scriptCommandVariants || []).concat([this.declaration.scriptCommand])
  }

  satisfiesVariants (counsel) {
    const pkg = counsel.targetProjectPackageJson
    const name = this.declaration.scriptName
    if (!pkg.scripts) return false
    const actual = pkg.scripts[name]
    if (!actual) return false
    if (this.isAnyVariantValid) return true
    const variants = this.getVariants()
    return variants
    .filter(variant => variant)
    .some(function testIfCmdMatchesVariant (variant) {
      if (actual.trim() === variant) return true
      if (variant.test &amp;&amp; variant.test(actual.trim())) return true
      return false
    })
  }
}

module.exports = ScriptRule
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
